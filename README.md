<div align="center">
  <h1>osgrep</h1>
  <p><em>Slash tokens. Save time. Semantic search for your coding agent.</em></p>
  <a href="https://opensource.org/licenses/Apache-2.0"><img src="https://img.shields.io/badge/License-Apache%202.0-blue.svg" alt="License: Apache 2.0" /></a><br>
</div>



Natural-language search that works like `grep`. Fast, local, and built for coding agents.

- **Semantic:** Finds concepts ("where do transactions get created?"), not just strings.
- **Call Graph Tracing:** Map dependencies with `--trace` to see who calls what.
- **Role Detection:** Distinguishes `ORCHESTRATION` (high-level logic) from `DEFINITION` (types/classes).
- **Local & Private:** 100% local embeddings via `onnxruntime-node`.
- **Auto-Isolated:** Each repository gets its own index automatically.
- **Agent-Ready:** Native JSON output with symbols, roles, and call graphs.

## Quick Start

1. **Install**
   ```bash
   npm install -g osgrep
   ```

2.  **Setup (Recommended)**

    ```bash
    osgrep setup
    ```

    Downloads embedding models (~150MB) upfront. If you skip this, models download automatically on first use.

3.  **Search**

    ```bash
    cd my-repo
    osgrep "where do we handle authentication?" --json
    ```

    **Your first search will automatically index the repository.** Each repository is automatically isolated with its own index. Switching between repos "just works" — no manual configuration needed. If the background server is running (`osgrep serve`), search goes through the hot daemon; otherwise it falls back to on-demand indexing.

4.  **Trace** (Call Graph)

    ```bash
    osgrep search --trace "function_name" --json
    ```

    See who calls a function (upstream dependencies) and what it calls (downstream dependencies). Perfect for impact analysis and understanding code flow.

In our public benchmarks, `osgrep` can save about 20% of your LLM tokens and deliver a 30% speedup.

<div align="center">
  <img src="public/bench.png" alt="osgrep benchmark" width="100%" style="border-radius: 8px; margin: 20px 0;" />
</div>



## Coding Agent Integration

### For AI Agents (Claude, GPT, Gemini, etc.)

osgrep provides two commands optimized for agent workflows:

1. **`osgrep search "query" --json`** - Semantic search with role detection
   - Find code by concept: *"how does authentication work"*
   - Results include `role` (ORCHESTRATION vs DEFINITION) and `score` (relevance)
   - Look for `role === "ORCHESTRATION" && score > 0.7` for main logic

2. **`osgrep search --trace "SymbolName" --json`** - Call graph analysis
   - Impact analysis: *"what depends on this function?"*
   - Flow understanding: *"what does this call?"*
   - Returns `callers` (upstream) and `callees` (downstream)

**Example Agent Workflow:**
```bash
# User asks: "How does request validation work?"

# Step 1: Find the implementation
osgrep search "request validation logic" --json
# → Returns: get_request_handler (role: ORCHESTRATION, score: 0.85)

# Step 2: Trace to see dependencies
osgrep search --trace "get_request_handler" --json
# → Shows: 8 callers (entry points), 28 callees (operations)

# Step 3: Read key files
# Use paths from results to read implementation details
```

See [SKILL.md](SKILL.md) for complete agent integration guide.

### Claude Code Plugin

1. Run `osgrep install-claude-code`
2. Open Claude Code (`claude`) and ask it questions about your codebase.
3. Highly recommend indexing your code base before using the plugin.
4. The plugin's hooks auto-start `osgrep serve` in the background and shut it down on session end. Claude will use `osgrep` for semantic searches automatically but can be encouraged to do so.

## Commands

### `osgrep search`

The default command. Searches the current directory using semantic meaning.

```bash
osgrep "how is the database connection pooled?" --json
```

**Options:**
| Flag | Description | Default |
| --- | --- | --- |
| `-m <n>` | Max total results to return. | `25` |
| `--per-file <n>` | Max matches to show per file. | `1` |
| `-c`, `--content` | Show full chunk content instead of snippets. | `false` |
| `--compact` | Show file paths only (like `grep -l`). | `false` |
| `--json` | Output results as JSON with rich metadata (roles, symbols). **Recommended for agents.** | `false` |
| `--trace <symbol>` | Trace call graph for a specific symbol (who calls it, what it calls). | - |
| `-s`, `--sync` | Force re-index changed files before searching. | `false` |
| `-r`, `--reset` | Reset the index and re-index from scratch. | `false` |

**JSON Output (for AI Agents):**

When using `--json`, osgrep returns structured data:

**Search Results:**
```json
{
  "results": [
    {
      "text": "// src/server.ts > startServer\nfunction startServer() {...}",
      "score": 0.85,
      "metadata": {
        "path": "src/server.ts",
        "hash": "abc123..."
      },
      "generated_metadata": {
        "start_line": 42,
        "num_lines": 15,
        "type": "function"
      },
      "defined_symbols": ["startServer"],
      "referenced_symbols": ["db.connect", "app.listen"],
      "role": "ORCHESTRATION",
      "parent_symbol": "ServerManager",
      "context": ["// context from surrounding code"]
    }
  ]
}
```

**Trace Results:**
```json
{
  "graph": {
    "center": {
      "symbol": "request_handler",
      "file": "src/api.ts",
      "line": 127,
      "role": "ORCHESTRATION",
      "calls": ["validate", "authenticate", "process"],
      "calledBy": []
    },
    "callers": [
      {
        "symbol": "app_router",
        "file": "src/routes.ts",
        "line": 45,
        "role": "ORCHESTRATION",
        "calls": ["request_handler"]
      }
    ],
    "callees": [
      "validate",
      "authenticate",
      "process"
    ]
  },
  "metadata": {
    "count": 1,
    "query": "request_handler"
  }
}
```

**Key Fields:**
- **`role`**: `ORCHESTRATION` (coordinates logic) or `DEFINITION` (defines types/classes)
- **`score`**: 0-1 relevance score (>0.7 = highly relevant)
- **`defined_symbols`**: Functions/classes defined in this chunk
- **`referenced_symbols`**: Functions/classes called by this chunk
- **`callers`**: (Trace only) Upstream: who depends on this
- **`callees`**: (Trace only) Downstream: what this depends on

**Examples:**

```bash
# Semantic search with structured output
osgrep search "API rate limiting logic" --json

# Find implementation and trace dependencies
osgrep search "authentication flow" --json
osgrep search --trace "authenticate" --json

# Impact analysis: what depends on this function?
osgrep search --trace "validateUser" --json
# → Check callers.length for impact scope

# Deep dive (show more matches per file)
osgrep "error handling" --per-file 5

# Just give me the files
osgrep "user validation" --compact
```

### `osgrep index`

Manually indexes the repository. Useful if you want to pre-warm the cache or if you've made massive changes outside of the editor.

- Respects `.gitignore` and `.osgrepignore` (see [Configuration](#ignoring-files) section).
- **Smart Indexing:** Only embeds code and config files. Skips binaries, lockfiles, and minified assets.
- **Bounded Concurrency:** Uses a fixed thread pool to keep your system responsive.

```bash
osgrep index              # Index current dir
osgrep index --dry-run    # See what would be indexed
```

### `osgrep serve`

Runs a lightweight HTTP server with live file watching so searches stay hot in RAM.

- Keeps LanceDB and the embedding worker resident for <50ms responses.
- Watches the repo (via chokidar) and incrementally re-indexes on change.
- Health endpoint: `GET /health`
- Search endpoint: `POST /search` with `{ query, limit, path, rerank }`
- Writes lock: `.osgrep/server.json` with `port`/`pid`

Usage:

```bash
osgrep serve             # defaults to port 4444
OSGREP_PORT=5555 osgrep serve
```

Claude Code hooks start/stop this automatically; you rarely need to run it manually.

### `osgrep list`

Lists all indexed repositories (stores) and their metadata.

```bash
osgrep list
```

Shows store names, sizes, and last modified times. Useful for seeing what's indexed and cleaning up old stores.

### `osgrep doctor`

Checks installation health, model paths, and database integrity.

```bash
osgrep doctor
```

## Performance & Architecture

osgrep is designed to be a "good citizen" on your machine:

1.  **Bounded Concurrency:** Chunking/embedding stay within small thread pools (1–4) and capped batch sizes to keep laptops responsive.
2.  **Smart Chunking:** Uses `tree-sitter` to split code by function/class boundaries, ensuring embeddings capture complete logical blocks.
3.  **Deduplication:** Identical code blocks (boilerplate, license headers) are embedded once and cached, saving space and time.
4.  **Semantic Split Search:** Queries both "Code" and "Docs" separately to ensure documentation doesn't drown out implementation details, then reranks with ColBERT.
5.  **Global Batching:** A producer/consumer pipeline decouples chunking from embedding. Files are chunked concurrently, queued, embedded in fat batches, and written to LanceDB in bulk.
6.  **Anchor-Only Scans & Batch Deletes:** File discovery and stale cleanup hit only anchor rows, and stale/changed paths are removed with a single `IN` delete to minimize I/O.
7.  **Structural Boosting:** Function/class chunks get a small score boost; test/spec paths are slightly downweighted to bubble up primary definitions first.
8.  **Role Classification:** Detects `ORCHESTRATION` functions (high complexity, many calls) vs `DEFINITION` (types/classes) to help agents prioritize where to read.

## Configuration

### Automatic Repository Isolation

osgrep automatically creates a unique index for each repository based on:

1. **Git Remote URL** (e.g., `github.com/facebook/react` → `facebook-react`)
2. **Git Repo without Remote** → directory name + hash (e.g., `utils-7f8a2b3c`)
3. **Non-Git Directory** → directory name + hash for collision safety

**Examples:**
```bash
cd ~/work/myproject        # Auto-detected: owner-myproject
osgrep "API handlers"

cd ~/personal/utils        # Auto-detected: utils-abc12345
osgrep "helper functions"
```

Stores are isolated automatically — no manual `--store` flags needed!

### Ignoring Files

osgrep respects both `.gitignore` and `.osgrepignore` files when indexing. Create a `.osgrepignore` file in your repository root to exclude additional files or patterns from indexing.

**`.osgrepignore` syntax:**
- Uses the same pattern syntax as `.gitignore`
- Patterns are relative to the repository root
- Supports glob patterns, negation (`!`), and directory patterns (`/`)


### Manual Store Management

  - **View all stores:** `osgrep list`
  - **Override auto-detection:** `osgrep --store custom-name "query"`
  - **Clean up old stores:** `rm -rf ~/.osgrep/data/store-name`
  - **Data location:** `~/.osgrep/data`

## Development

```bash
pnpm install
pnpm build        # or pnpm dev
pnpm format       # biome check
```

## Troubleshooting

  - **Index feels stale?** Run `osgrep index` to refresh.
  - **Weird results?** Run `osgrep doctor` to verify models.
  - **Need a fresh start?** Delete `~/.osgrep/data` and `~/.osgrep/meta.json` and run `osgrep index`.

## Attribution

osgrep is built upon the foundation of [mgrep](https://github.com/mixedbread-ai/mgrep) by MixedBread. We acknowledge and appreciate the original architectural concepts and design decisions that informed this work.


See the [NOTICE](NOTICE) file for detailed attribution information.

## License

Licensed under the Apache License, Version 2.0.
See [LICENSE](LICENSE) and [Apache-2.0](https://opensource.org/licenses/Apache-2.0) for details.

